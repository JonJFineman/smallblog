#!/bin/sh

# Copyright (c) 2013, Aaron Fineman <aaron@fineman.me>
#
# Permission to use, copy, modify, and/or distribute this software for
# any purpose with or without fee is hereby granted, provided that the
# above copyright notice and this permission notice appear in all
# copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS
# ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO
# EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
# INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,
# WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
# TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE
# USE OR PERFORMANCE OF THIS SOFTWARE.

# Configuration
title="blog"				# The title of your blog
max_posts=3					# Maximum posts on the front page

# Generate the header
blog_header="
<!-- HTML generated by smallblog <https://github.com/abyxcos/smallblog> -->
<!DOCTYPE html>
<html>
	<head>
		<title>$title</title>
		<link rel=\"stylesheet\" href=\"/blog/main.css\">
	</head>
	<body>
		<div class=\"container\">
			<div class=\"site\">
				<div class=\"header\">
					<h1 class=\"title\"><a href=\"/blog\">mnetic.ch/blog</a></h1>
					<a class=\"extra\" href=\"/blog/archive.html\">all posts</a>
				</div>
"
# Generate the footer
blog_footer="
			</div>
		</div>
	</body>
</html>
"

make_post(){
	echo "$1"
	echo "<h2 class=\"title\"><a href='/blog/$3.html'>
		`head -n1 $3 | sed 's/^#* //'`
		</a></h2>
		<p class=\"meta\">Date: $4</p>
		<div class=\"post\">"
	tail -n+2 "$3" | markdown
	echo "</div>"
	echo "$2"
}

make_archive(){
	month="00"

	echo "${blog_header}"
	echo "<h2>Archives:</h2>"
	echo "<ul class=\"posts\">"

	for post in `ls -r */*/*/*.md`; do
		newmonth=`echo "${post}" | sed 's/^[0-9]*\///' | sed 's/\/.*//'`
		if [ "${month}" -ne "${newmonth}" ]; then
			month="${newmonth}"
			echo "<h3>`echo ${post} | sed 's/\/.*//'` - ${month}</h3>"
		fi

		time=`stat -c %y ${post} | sed 's/ .*//'`
		title=`head -n1 ${post} | sed 's/#* //'`
		echo "<li><span>${time}</span> &raquo; <a href=\"/blog/${post}.html\">${title}</a></li>"
	done

	echo "</ul>"
	echo "${blog_footer}"
}

echo "${blog_header}" > index.html
for post in `ls -r */*/*/*.md`; do
time=`stat -c %y ${post} | sed 's/\..* / /'`

make_post "${blog_header}" "${blog_footer}" "${post}" "${time}" > "${post}.html"

if [ ${max_posts} -gt 0 ]; then
	make_post "" "" "${post}" "${time}" >> index.html
	max_posts=`expr ${max_posts} - 1`
fi

done
make_archive > archive.html
echo "<h3><a class=\"extra\" href=\"/blog/archive.html\">all posts</a></h3>" >> index.html
echo "${blog_footer}" >> index.html
