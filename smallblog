#!/bin/sh

# Copyright (c) 2013, Aaron Fineman <abyxcos@mnetic.ch>
#
# Permission to use, copy, modify, and/or distribute this software for
# any purpose with or without fee is hereby granted, provided that the
# above copyright notice and this permission notice appear in all
# copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS
# ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO
# EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
# INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,
# WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
# TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE
# USE OR PERFORMANCE OF THIS SOFTWARE.

# Program configuration
PREFIX=/blog				# Root folder for your blog
TIME_CMD="stat -c %y %FILE | sed 's/\..* / /'" # Form: DATE TIME TIMEZONE
#TIME_CMD="stat -f \"%Y-%m-%d %H:%M:%S %z\" %FILE" # BSD stat, command untested
max_posts=3					# Maximum posts on the front page

# User configuarion
title="blog"				# The title of your blog
name="Aaron Fineman"		# Name for footer
email="abyxcos@mnetic.ch"	# Email for footer
footer2_text="github:"		# Second line for footer
footer2_link="https://github.com/abyxcos/"	# Second link for footer

blog_header="
<!-- HTML generated by smallblog <https://github.com/abyxcos/smallblog> -->
<!DOCTYPE html>
<html>
	<head>
		<title>$title</title>
		<link rel=\"stylesheet\" href=\"${PREFIX}/main.css\">
		<link rel=\"stylesheet\" href=\"main.css\">
	</head>
	<body>
		<div class=\"container\">
			<div class=\"site\">
				<div class=\"header\">
					<h1 class=\"title\"><a href=\"${PREFIX}\">mnetic.ch/blog</a></h1>
					<a class=\"extra\" href=\"${PREFIX}/tags/\">tags</a>
					<a class=\"extra\" href=\"${PREFIX}/archive.html\">all posts</a>
					<a class=\"extra\" href=\"${PREFIX}/feed.rss\">rss</a>
				</div>"
blog_footer="
				<div class=\"footer\">
					<div class=\"contact\">
						<p>
							${name}<br />
							${footer2_text}
						</p>
					</div>
					<div class=\"contact\">
						<p>
							<a href=\"mailto:${email}\">${email}</a><br />
							<a href=\"${footer2_link}\">${footer2_link}</a>
						</p>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>"

make_post(){
	_time=`eval ${TIME_CMD/\%FILE/$1}`

	echo "
		<h2 class=\"title\"><a href='${PREFIX}/$1.html'>
		`head -n1 $1 | sed 's/^#* //'`
		</a></h2>
		<p class=\"meta\">Date: ${_time}</p>
		<div class=\"post\">"
	tail -n+2 "$1" | markdown |\
		sed 's/^<p>tags: /<p class=\"meta\">tags: /'
	echo "<br /></div>"
}

# make_index folder title
make_index(){
	_month="00"

	echo "${blog_header}"
	echo "<h2>$2:</h2>"
	echo "<ul class=\"posts\">"

	for post in `ls -r ${1}/*.md`; do
		_title=`head -n1 "${post}" | sed 's/#* //'`
		_time=`eval ${TIME_CMD/\%FILE/${post}} | sed 's/ .*//'`
		_newmonth=`echo "${_time}" | sed 's/^[0-9]*-//' | sed 's/-.*$//'`

		if [ "${_month}" -ne "${_newmonth}" ]; then
			_month="${_newmonth}"
			echo "<h3>`echo ${_time} | sed 's/-.*//'` - ${_month}</h3>"
		fi

		echo "<li><span>${_time}</span> &raquo; <a href=\"${PREFIX}/${post}.html\">${_title}</a></li>"
	done

	echo "</ul>"
	echo "${blog_footer}"
}

# Generate the tags index page
make_tags_index(){
	echo "${blog_header}"
	echo "<h2>Tags:</h2>"
	echo "<ul class=\"posts\">"

	for tag in `ls -r tags`; do
		if [ -d "tags/${tag}" ]; then
			echo "<li><a href=\"${tag}\">${tag}</a></li>"
		fi
	done

	echo "</ul>"
	echo "${blog_footer}"
}

make_tags(){
	rm tags/*/*		# Delete all the post symlinks
	rm tags/index.html	# Delete the hanging tags index
	rmdir tags/*		# Delete all the tags

	for post in `ls -r */*/*/*.md`; do
		# Grab tags from the tags: line in the post
		tags=`grep '^tags: ' ${post} | sed 's/^tags: //'`
		for tag in ${tags}; do
			mkdir -p "tags/${tag}"
			ln -s "../../${post}" "tags/${tag}/${post##*\/}"
			ln -s "../../${post}.html" "tags/${tag}/${post##*\/}.html"
		done
		# Generate the tag page
		make_index "tags/${tag}" "${tag}" > "tags/${tag}/index.html"
	done
}

make_rss(){
	link_ident='<h2 class="title">'

	echo "<?xml version=\"1.0\" encoding=\"utf-8\" ?>"
	echo "<rss version=\"2.0\">"
	echo "<channel>"
	echo "<title>$title</title>"
	echo "<description>$title</description>"
	echo "<link>http://mnetic.ch/blog</link>"
	echo "<ttl>1800</ttl>"
	for post in `ls -r */*/*/*.md | head -n${max_posts}`; do
		link=`grep "${link_ident}" "${post}.html"`
		echo "<item>"
		echo "<title>"
		grep -A1 "${link}" "${post}.html" | grep -v "${link}" | sed 's/^\s*//'
		echo "</title>"
		echo "<link>"
		echo "${link}" | sed "s/^\s*${link_ident}<a href='//" | sed "s/'>$//"
		echo "</link>"
		echo "<pubDate>"
		grep '<p class="meta">Date:' "${post}.html" | sed 's/^\s*<p class="meta">Date: //' | sed 's/<\/p>$//'
		echo "</pubDate>"
		echo "<description>"
		#markdown < "${post}" # FIXME: Special characters make RSS unhappy
		echo "</description>"
		echo "</item>"
	done
	echo "</channel>"
	echo "</rss>"
}


# Generate the individual posts
for post in `ls -r */*/*/*.md`; do
	echo "${blog_header} `make_post "${post}"` ${blog_footer}" > "${post}.html"
done

# Generate the blog front page (index.html)
echo -n "" > index.html
echo "${blog_header}" >> index.html
for post in `ls -r */*/*/*.md | head -n${max_posts}`; do
	make_post "${post}" >> index.html
done
echo "<h3><a class=\"extra\" href=\"${PREFIX}/archive.html\">all posts</a></h3>" >> index.html
echo "${blog_footer}" >> index.html

# Generate the archive page of all posts
make_index "*/*/*" "Archives" > archive.html

# Generate the tags directory structure and index pages
make_tags
for tag in `ls -r tags`; do
	make_index "tags/${tag}" "${tag}" > "tags/${tag}/index.html"
done
make_tags_index > tags/index.html

# Generate an rss feed of the front page
make_rss > feed.rss
