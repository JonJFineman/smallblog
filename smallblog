#!/bin/sh

# Copyright (c) 2013, Aaron Fineman <aaron@fineman.me>
#
# Permission to use, copy, modify, and/or distribute this software for
# any purpose with or without fee is hereby granted, provided that the
# above copyright notice and this permission notice appear in all
# copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS
# ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO
# EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
# INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,
# WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
# TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE
# USE OR PERFORMANCE OF THIS SOFTWARE.

# Configuration
title="blog"				# The title of your blog
name="Aaron Fineman"		# Name for footer
email="abyxcos@mnetic.ch"	# Email for footer
footer2_text="github:"		# Second line for footer
footer2_link="https://github.com/abyxcos/"	# Second link for footer
max_posts=3					# Maximum posts on the front page

blog_header="
<!-- HTML generated by smallblog <https://github.com/abyxcos/smallblog> -->
<!DOCTYPE html>
<html>
	<head>
		<title>$title</title>
		<link rel=\"stylesheet\" href=\"/blog/main.css\">
	</head>
	<body>
		<div class=\"container\">
			<div class=\"site\">
				<div class=\"header\">
					<h1 class=\"title\"><a href=\"/blog\">mnetic.ch/blog</a></h1>
					<a class=\"extra\" href=\"/blog/tags/\">tags</a>
					<a class=\"extra\" href=\"/blog/archive.html\">all posts</a>
					<a class=\"extra\" href=\"/blog/feed.rss\">rss</a>
				</div>"
blog_footer="
				<div class=\"footer\">
					<div class=\"contact\">
						<p>
							Aaron Fineman<br />
							${footer2_text}
						</p>
					</div>
					<div class=\"contact\">
						<p>
							<a href=\"mailto:${email}\">${email}</a><br />
							<a href=\"${footer2_link}\">${footer2_link}</a>
						</p>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>"

make_post(){
	time=`stat -c %y "$3" | sed 's/\..* / /'`
	#time=`stat -f "%Y-%m-%d %H:%M:%S %z" "$3"` # BSD stat, command untested

	echo "$1"
	echo "<h2 class=\"title\"><a href='/blog/$3.html'>
		`head -n1 $3 | sed 's/^#* //'`
		</a></h2>
		<p class=\"meta\">Date: ${time}</p>
		<div class=\"post\">"
	tail -n+2 "$3" | markdown
	echo "</div>"
	echo "$2"
}

# make_index folder title
make_index(){
	month="00"

	echo "${blog_header}"
	echo "<h2>$2:</h2>"
	echo "<ul class=\"posts\">"

	for post in `ls -r ${1}/*.md`; do
		title=`head -n1 "${post}" | sed 's/#* //'`
		time=`stat -c %y "${post}" | sed 's/ .*//'`
		#time=`stat -f "%Y-%m-%d %H:%M:%S %z" "${post}"` # BSD stat, command untested
		newmonth=`echo "${time}" | sed 's/^[0-9]*-//' | sed 's/-.*$//'`

		if [ "${month}" -ne "${newmonth}" ]; then
			month="${newmonth}"
			echo "<h3>`echo ${time} | sed 's/-.*//'` - ${month}</h3>"
		fi

		echo "<li><span>${time}</span> &raquo; <a href=\"/blog/${post}.html\">${title}</a></li>"
	done

	echo "</ul>"
	echo "${blog_footer}"
}

make_tags(){
	rm tags/*/*		# Delete all the post symlinks
	rmdir tags/*	# Delete all the tags

	for post in `ls -r */*/*/*.md`; do
		tags=`grep '^tags: ' ${post} | sed 's/^tags: //'`
		for tag in ${tags}; do
			if [ ! -d tags/"${tag}" ]; then
				mkdir "tags/${tag}"
			fi
			postname=`echo "${post}" | sed 's/^.*\///'`
			ln -s "../../${post}" "tags/${tag}/${postname}"
			ln -s "../../${post}.html" "tags/${tag}/${postname}.html"
		done
	done
}

make_tag_index(){
	echo "${blog_header}"
	echo "<h2>Tags:</h2>"
	echo "<ul class=\"posts\">"

	for tag in `ls -r $1`; do
		if [ -d "$1/${tag}" ]; then
			echo "<li><a href=\"${tag}\">${tag}</a></li>"
		fi
	done

	echo "</ul>"
	echo "${blog_footer}"
}

make_rss(){
	echo "<?xml version=\"1.0\" encoding=\"utf-8\" ?>"
	echo "<rss version=\"2.0\">"
	echo "<channel>"
	echo "<title>$title</title>"
	echo "<description>$title</description>"
	echo "<link>http://mnetic.ch/blog</link>"
	echo "<ttl>1800</ttl>"
	for post in `ls -r */*/*/*.md`; do
		link_ident='<h2 class="title">'
		link=`grep "${link_ident}" "${post}.html"`
		echo "<item>"
		echo "<title>"
		grep -A1 "${link}" "${post}.html" | grep -v "${link}" | sed 's/^\s*//'
		echo "</title>"
		echo "<link>"
		echo "${link}" | sed "s/^${link_ident}<a href='//" | sed "s/'>$//"
		echo "</link>"
		echo "<pubDate>"
		grep '<p class="meta">Date:' "${post}.html" | sed 's/^\s*<p class="meta">Date: //' | sed 's/<\/p>$//'
		echo "</pubDate>"
		echo "<description>"
		markdown < "${post}"
		echo "</description>"
		echo "</item>"
	done
	echo "</channel>"
	echo "</rss>"
}

echo "${blog_header}" > index.html
for post in `ls -r */*/*/*.md`; do

make_post "${blog_header}" "${blog_footer}" "${post}" > "${post}.html"

if [ ${max_posts} -gt 0 ]; then
	make_post "" "" "${post}" "${time}" >> index.html
	max_posts=`expr ${max_posts} - 1`
fi

done
make_index "*/*/*" "Archives" > archive.html
echo "<h3><a class=\"extra\" href=\"/blog/archive.html\">all posts</a></h3>" >> index.html
echo "${blog_footer}" >> index.html

rm tags/index.html
make_tags
for tag in `ls -r tags`; do
	make_index "tags/${tag}" "${tag}" > "tags/${tag}/index.html"
done
make_tag_index tags > tags/index.html
make_rss > feed.rss
