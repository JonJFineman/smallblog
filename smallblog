#!/bin/sh

# Copyright (c) 2013, Aaron Fineman <aaron@fineman.me>
#
# Permission to use, copy, modify, and/or distribute this software for
# any purpose with or without fee is hereby granted, provided that the
# above copyright notice and this permission notice appear in all
# copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS
# ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO
# EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
# INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,
# WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
# TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE
# USE OR PERFORMANCE OF THIS SOFTWARE.

# Configuration
out_file="index.html"	# The html file generated in your blog root
title="blog"				# The title of your blog
max_posts=3					# Maximum posts on the front page


# Generate the header
blog_header="
<!-- HTML generated by smallblog <https://github.com/abyxcos/smallblog> -->
<!DOCTYPE html>
<html>
	<head>
		<title>$title</title>
		<link rel="stylesheet" href="/blog/main.css">
	</head>
	<body>
		<div class="container">
			<div class="site">
				<div class"header">
					<h1 class="title"><a href="/blog">mnetic.ch/blog</a></h1>
				</div>
"
# Generate the footer
blog_footer="
			</div>
		</div>
	</body>
</html>
"


make_post(){
	echo "$1$3"
	tail -n+2 "$5" | markdown
	echo "$4$2"
}


echo "${blog_header}" > "${out_file}"
# Iterate over year/month/day/* to generate an output
#for year in `ls -r`; do
#	if [ -d "${year}" ]; then
#		for month in `ls -r "${year}/"`; do
#			for day in `ls -r "${year}/${month}/"`; do
#				for post in `ls -t "${year}/${month}/${day}/"`; do
#					if echo "${post}" | grep -q "\.md$"; then
for post in `ls -t */*/*/*.md`; do
#post_path="${year}/${month}/${day}/"
#time=`stat -c %y ${post_path}/${post} | awk '{ printf $2 " " $3 }' | sed 's/\..* / /'`
time=`stat -c %y ${post} | awk '{ printf $2 " " $3 }' | sed 's/\..* / /'`

post_header="
<p><div class=\"post\">
<h3 class=\"title\"><a href='/blog/${post}.html'>
	`head -n1 ${post} | sed 's/^#* //'`
</a></h3>
<p class=\"meta\">Date: ${year}-${month}-${day} ${time}</p>"
post_footer="</div></p>"


make_post "${blog_header}" "${blog_footer}" "${post_header}" "${post_footer}" "${post}" > "${post}.html"

if [ ${max_posts} -gt 0 ]; then
	make_post "" "" "${post_header}" "${post_footer}" "${post}" >> "${out_file}"
fi
max_posts=`expr ${max_posts} - 1`

#					fi
#				done
#			done
#		done
#	fi
done
echo "${blog_footer}" >> "${out_file}"
